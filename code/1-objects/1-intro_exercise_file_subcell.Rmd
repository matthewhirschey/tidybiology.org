---
title: "Exercise: Subcellular Data"
output: html_notebook
---

##Load libraries
```{r load_block, warning=FALSE, echo=TRUE}
library(tidyverse)

#you're going to need a few more packages, so make sure to download them before trying to load the libraries; each of these is on CRAN, so you should be able to get them easily
library(janitor)
library(viridis)
library(ggridges)
```

#import data
The raw data were originally downloaded from [here](https://www.uniprot.org). But now, they are on the tidybiology website, so we can grab from there.  
```{r}
proteins_url <- "https://github.com/matthewhirschey/tidybiology.org/raw/main/data/uniprot-filtered-reviewed%253Ayes%2BAND%2Borganism%253A%2522Homo%2Bsapiens%2B%2528Human%2529%2B%255B96--.tab"
proteins_raw <- 
  read_tsv(proteins_url, col_names = TRUE) %>% 
  clean_names() %>% 
  dplyr::select(-status, -entry_name)
```

## Get to know your dataset
The `proteins_raw` object is a table (also called a dataframe), that has a series of columns and rows. The function `glimpse()` perfroms a quick peek at the data. We can see that this table has 7 columns (called 'Variables'), and 20431 rows (called 'Observations'). The name of each Variable is listed below (e.g. 'id', etc.). Importantly, R cares about capitalization, so `entry` is NOT the same as `ENTRY`. The type of variable is listed next (e.g. <fct>, <dbl>, etc.), as we discussed. Lastly, the first few observations are listed.  
  
```{r glimpse}
#Take a `glimpse` into the kinds of data in the proteins_raw dataframe
```

#clean
One of the biggest challenges when working with new data is to "clean" it, which means get it into a state that you can use it for something useful...like visualization! The overall goal is to clean-up a super messy column called `subcellular_location_cc`. We've already performed some cleaning steps for you below. While you might not understand everystep, read the comments to see what the code is doing.  
  
We are going to save this "cleaned" dataframe as a new object called 'subcell', which is short-hand for subcellular location. 
```{r}
#the overall goal is to clean-up a super messy column called "subcellular_location_cc"
subcell <- 
  proteins_raw %>%
  #looks for the word SUBCELLULAR, and filters ot include only those
  filter(str_detect(subcellular_location_cc, "SUBCELLULAR")) %>% 
  #removes the word SUBCELLULAR
  mutate(subcellular_location_cc = str_remove_all(subcellular_location_cc, "SUBCELLULAR LOCATION\\: ")) %>%
  #this is a trick to use separate() to split the text (sep = ...) and then drops the split
  separate(subcellular_location_cc, into = c("subcellular_location_cc"), sep = "Note") %>% 
  separate(subcellular_location_cc, into = c("subcellular_location_cc"), sep = "\\;") %>% 
  separate(subcellular_location_cc, into = c("subcellular_location_cc"), sep = "\\{") %>% 
  separate(subcellular_location_cc, into = c("subcellular_location_cc"), sep = "\\,") %>% 
  separate(subcellular_location_cc, into = c("subcellular_location_cc"), sep = "\\.") %>% 
  separate(subcellular_location_cc, into = c("temp", "subcellular_location_cc"), sep = "\\:", fill = "left") %>% 
  #we add a temp column in this last separate(), so we remove it here
  dplyr::select(-temp)

#because of cleaning, some locations were listed as gene names; easy way to omit is if they are a single instance
omit <- 
  subcell %>% 
  count(subcellular_location_cc, sort = TRUE) %>% 
  filter(n == 1) %>% 
  pull(subcellular_location_cc)

#this then filters out the omitted locations
subcell <- 
  subcell %>% 
  #single instances
  filter(!subcellular_location_cc %in% omit) %>% 
  #length is 0 for a few instance; omit
  filter(str_length(subcellular_location_cc) > 0) 

#make it so that white space does not make separate categories
subcell$subcellular_location_cc <- str_trim(subcell$subcellular_location_cc, side = "both") 
```


#Exploratory Data Analysis (EDA)
We are now left with a 'clean' data frame, with a new column called "subcellular_location_cc" which has a simple
```{r}
#What are some of the characteristics of the human protein lengths?
subcell %>% 
  summarize(avg = mean(length), 
            sd = sd(length), 
            median = median(length), 
            min = min(length),
            max = max(length))

#Which subcellular locations have most annotated proteins?
subcell %>% 
  count(subcellular_location_cc, sort = TRUE)

#What is longest protein in each subcellular compartment?
subcell %>% 
  group_by(subcellular_location_cc) %>% 
  summarize(longest = max(length))

```
#viz
```{r}
#first visualization
subcell %>% 
  ggplot(aes(x = length)) +
  geom_histogram(bins = 100)

#filter outlier
subcell %>% 
  filter(length < 10000) %>% 
  ggplot(aes(x = length)) +
  geom_histogram(bins = 100)

#focus on one place
subcell %>% 
  filter(length < 10000) %>% 
  filter(subcellular_location_cc %in% "Mitochondrion") %>% 
  ggplot(aes(x = length)) +
  geom_histogram(bins = 100)

#more than one mito location
subcell %>% 
  filter(length < 10000) %>% 
  filter(subcellular_location_cc %in% c("Mitochondrion", "Mitochondrion inner membrane")) %>% 
  ggplot(aes(x = length)) +
  geom_histogram(bins = 100)

#color by place
subcell %>% 
  filter(length < 10000) %>% 
  filter(subcellular_location_cc %in% c("Mitochondrion", "Mitochondrion inner membrane")) %>% 
  ggplot(aes(x = length, fill = subcellular_location_cc)) +
  geom_histogram(bins = 100)

#get all mito proteins
subcell %>% 
  filter(length < 10000) %>% 
  filter(str_detect(subcellular_location_cc, "Mito")) %>% 
  ggplot(aes(x = length, fill = subcellular_location_cc)) +
  geom_histogram(bins = 100)
```

#viz all
```{r}
ggplot(data = subcell, aes(x = length, fill = subcellular_location_cc)) +
  geom_histogram(bins = 100) 

ggplot(data = subcell, aes(x = length, fill = subcellular_location_cc)) +
  geom_histogram(bins = 100, show.legend = FALSE) 

ggplot(data = subcell, aes(x = length, fill = fct_lump(subcellular_location_cc, 10))) +
  geom_histogram(bins = 100, show.legend = TRUE)

ggplot(data = subcell, aes(x = log(length), fill = fct_lump(subcellular_location_cc, 10))) +
  geom_histogram(bins = 100, show.legend = TRUE)

ggplot(data = subcell, aes(x = log(length), fill = fct_lump(subcellular_location_cc, 10))) +
  geom_histogram(bins = 100, show.legend = TRUE) +
  labs(x = "AA length(log10)", y = "Count")

ggplot(data = subcell, aes(x = log(length), fill = fct_lump(subcellular_location_cc, 10))) +
  geom_histogram(bins = 100, show.legend = TRUE) +
  labs(x = "AA length(log10)", y = "Count") +
  scale_fill_viridis(discrete = TRUE)

ggplot(data = subcell, aes(x = log(length), fill = fct_lump(subcellular_location_cc, 10))) +
  geom_density(show.legend = TRUE) +
  labs(x = "AA length(log10)", y = "Count") +
  scale_fill_viridis(discrete = TRUE)

ggplot(data = subcell, aes(x = log(length), ..scaled.., fill = fct_lump(subcellular_location_cc, 10))) +
  geom_density(show.legend = TRUE) +
  labs(x = "AA length(log10)", y = "Count") +
  scale_fill_viridis(discrete = TRUE)

ggplot(data = subcell, aes(x = log(length), ..scaled.., fill = fct_lump(subcellular_location_cc, 10))) +
  geom_density(show.legend = TRUE, alpha = 0.7) +
  labs(x = "AA length(log10)", y = "Count") +
  scale_fill_viridis(discrete = TRUE)

ggplot(data = subcell, aes(x = log(length), y = fct_lump(subcellular_location_cc, 10),  fill = fct_lump(subcellular_location_cc, 10))) +
  geom_density_ridges(show.legend = FALSE, alpha = 0.7) +
  labs(x = "AA length(log10)", y = "", title = "Distribution of Protein length in subcellular compartments") +
  scale_fill_viridis(discrete = TRUE)

#I'd probably refactor/regroup the compartments to make them larger classes (think mito), and I'd also probably rank the visualization by the mean for each (high to low...it's current ranked by number of proteins in the compartment)
```

